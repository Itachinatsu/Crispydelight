<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Management</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f0f0;
    }
    .section {
      padding: 15px;
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
    }
    h1, h2, h3, h4 {
      margin: 10px 0;
    }
    h1 {
      font-size: 24px;
    }
    h2 {
      font-size: 20px;
    }
    h3, h4 {
      font-size: 18px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-blue { background-color: #007bff; color: white; }
    .btn-green { background-color: #28a745; color: white; }
    .btn-red { background-color: #dc3545; color: white; }
    .btn-yellow { background-color: #ffc107; color: black; }
    .btn-gray { background-color: #6c757d; color: white; }
    .btn-blue:hover, .btn-green:hover, .btn-red:hover, .btn-yellow:hover, .btn-gray:hover {
      opacity: 0.9;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 5px 0;
    }
    .card {
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .error {
      color: #dc3545;
      padding: 15px;
      text-align: center;
    }
    .notification {
      color: #28a745;
    }
    .flex-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .overflow-auto {
      overflow: auto;
      max-height: 100vh;
    }
    @media (max-width: 600px) {
      .section { padding: 10px; }
      button, input, select { font-size: 14px; }
      h1 { font-size: 20px; }
      h2 { font-size: 18px; }
      h3, h4 { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" integrity="sha256-JDEy1knU0qG7Q/4Q9SxfO8rM3wfL66L3zokzSwW8NJI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" integrity="sha256-0W3lDppArC8jBWKBg2l5EDW3vKGO2v7zTRG6NGE6vKY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js" integrity="sha256-WvD3j3rI47/2mXgR6nJ8hQvV1iL+dMhZsx0b0n3gX/g=" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script type="text/babel">
    try {
      // Check if required globals are available
      if (!window.React || !window.ReactDOM || !window.Babel || !window.firebase) {
        throw new Error("Missing required scripts: React, ReactDOM, Babel, or Firebase");
      }

      // Helper function to display errors safely
      const displayError = (title, message, details = '') => {
        const root = document.getElementById('root') || document.body;
        if (root) {
          root.innerHTML = `
            <div class="error">
              <h2>${title}</h2>
              <p>${message}</p>
              ${details ? `<p>Error: ${details}</p>` : ''}
              <button onclick="window.location.reload()" class="btn-blue">Reload</button>
            </div>
          `;
        } else {
          console.error("Cannot display error: No root or body element available");
        }
      };

      const { useState, useEffect } = React;

      // Firebase configuration for crispydelight-7ec1d
      const firebaseConfig = {
        apiKey: "AIzaSyCM3pJf9gVq3mlX0z2heC8rEUNyZ4Wzu2g",
        authDomain: "crispydelight-7ec1d.firebaseapp.com",
        databaseURL: "https://crispydelight-7ec1d-default-rtdb.firebaseio.com",
        projectId: "crispydelight-7ec1d",
        storageBucket: "crispydelight-7ec1d.firebasestorage.app",
        messagingSenderId: "1032037154266",
        appId: "1:1032037154266:web:86fddca8d4df94bff214e3",
        measurementId: "G-3RNNKVNF6P"
      };

      // Initialize Firebase with error handling
      let app, db;
      try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.database();
      } catch (error) {
        console.error("Firebase initialization failed:", error.message);
        displayError(
          "Error: Failed to connect to database",
          "Please check Firebase configuration or your internet connection.",
          error.message
        );
        throw error;
      }

      // Default menu with categories
      const defaultMenu = {
        Burgers: [
          { id: 1, name: "Classic Burger", price: 10 },
          { id: 2, name: "Cheese Burger", price: 12 }
        ],
        Mojitos: [
          { id: 3, name: "Classic Mojito", price: 5 },
          { id: 4, name: "Strawberry Mojito", price: 6 }
        ],
        Pizzas: [
          { id: 5, name: "Margherita Pizza", price: 15 },
          { id: 6, name: "Pepperoni Pizza", price: 16 }
        ],
        FriedChicken: [
          { id: 7, name: "Spicy Fried Chicken", price: 12 },
          { id: 8, name: "BBQ Fried Chicken", price: 13 }
        ]
      };

      // Error Boundary Component
      class ErrorBoundary extends React.Component {
        state = { hasError: false, error: null };

        static getDerivedStateFromError(error) {
          return { hasError: true, error };
        }

        render() {
          if (this.state.hasError) {
            return (
              <div className="error">
                <h2>Something went wrong</h2>
                <p>{this.state.error?.message || "Unknown error"}</p>
                <button onClick={() => window.location.reload()} className="btn-blue">Reload</button>
              </div>
            );
          }
          return this.props.children;
        }
      }

      // Home Screen
      const Home = ({ setSection }) => (
        <div className="container">
          <h1>Restaurant Management</h1>
          <button onClick={() => setSection('order')} className="btn-blue">Order Section</button>
          <button onClick={() => setSection('kitchen')} className="btn-green">Kitchen Section</button>
          <button onClick={() => setSection('admin')} className="btn-red">Admin Section</button>
        </div>
      );

      // Order Section
      const OrderSection = ({ setSection }) => {
        const [tables, setTables] = useState([]);
        const [selectedTable, setSelectedTable] = useState(null);
        const [order, setOrder] = useState([]);
        const [menu, setMenu] = useState(defaultMenu);
        const [notifications, setNotifications] = useState([]);

        useEffect(() => {
          if (!db) return;

          // Load table count from Firebase
          db.ref('settings/tableCount').once('value').then(snapshot => {
            const count = snapshot.val() || 5;
            setTables(Array.from({ length: count }, (_, i) => `Table ${i + 1}`));
          }).catch(error => console.error("Error loading table count:", error.message));

          // Load menu from Firebase
          db.ref('settings/menu').once('value').then(snapshot => {
            const savedMenu = snapshot.val();
            if (savedMenu) setMenu(savedMenu);
          }).catch(error => console.error("Error loading menu:", error.message));

          // Listen for kitchen notifications
          db.ref('orders').on('child_changed', snapshot => {
            const order = snapshot.val();
            if (order && order.status === 'ready') {
              setNotifications(prev => [...prev, { id: snapshot.key, table: order.table }]);
            }
          }, error => console.error("Error listening for orders:", error.message));
        }, []);

        const addToOrder = (item) => {
          setOrder(prev => [...prev, item]);
        };

        const submitOrder = () => {
          if (order.length === 0 || !db) return;
          const orderData = {
            table: selectedTable,
            items: order,
            status: 'pending',
            timestamp: Date.now()
          };
          db.ref('orders').push(orderData).then(() => {
            setOrder([]);
            setSelectedTable(null);
          }).catch(error => console.error("Error submitting order:", error.message));
        };

        const markAsPaid = (orderId) => {
          if (!db) return;
          db.ref(`orders/${orderId}`).update({
            status: 'paid',
            paidTimestamp: Date.now()
          }).then(() => {
            setNotifications(prev => prev.filter(note => note.id !== orderId));
          }).catch(error => console.error("Error marking as paid:", error.message));
        };

        if (selectedTable) {
          return (
            <div className="section overflow-auto">
              <h2>{selectedTable} - Menu</h2>
              {Object.keys(menu).map(category => (
                <div key={category} style={{ marginBottom: '15px' }}>
                  <h3>{category}</h3>
                  <div className="grid">
                    {menu[category].map(item => (
                      <button
                        key={item.id}
                        onClick={() => addToOrder(item)}
                        className="btn-blue"
                      >
                        {item.name} - ${item.price}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
              <h3>Current Order</h3>
              <ul>
                {order.map((item, index) => (
                  <li key={index}>{item.name} - ${item.price}</li>
                ))}
              </ul>
              <button onClick={submitOrder} className="btn-green">Confirm Order</button>
              <button onClick={() => setSelectedTable(null)} className="btn-gray">Back</button>
            </div>
          );
        }

        return (
          <div className="section">
            <h2>Order Section</h2>
            <div className="grid">
              {tables.map(table => (
                <button key={table} onClick={() => setSelectedTable(table)} className="btn-blue">
                  {table}
                </button>
              ))}
              <button onClick={() => setSelectedTable('Takeaway')} className="btn-blue">
                Takeaway
              </button>
            </div>
            <h3>Notifications</h3>
            <ul>
              {notifications.map((note, index) => (
                <li key={index} className="notification">
                  Order for {note.table} is ready!
                  <button onClick={() => markAsPaid(note.id)} className="btn-green">Mark as Paid</button>
                </li>
              ))}
            </ul>
            <button onClick={() => setSection('home')} className="btn-gray">Back to Home</button>
          </div>
        );
      };

      // Kitchen Section
      const KitchenSection = ({ setSection }) => {
        const [orders, setOrders] = useState([]);

        useEffect(() => {
          if (!db) return;

          db.ref('orders').on('value', snapshot => {
            const orderData = snapshot.val();
            if (orderData) {
              const orderList = Object.entries(orderData)
                .filter(([_, order]) => order.status === 'pending')
                .map(([id, order]) => ({ id, ...order }));
              setOrders(orderList);
            } else {
              setOrders([]);
            }
          }, error => console.error("Error loading orders:", error.message));
        }, []);

        const markAsReady = (orderId) => {
          if (!db) return;
          db.ref(`orders/${orderId}`).update({ status: 'ready' }).catch(error => console.error("Error marking as ready:", error.message));
        };

        return (
          <div className="section">
            <h2>Kitchen Section</h2>
            {orders.length === 0 ? (
              <p>No pending orders.</p>
            ) : (
              orders.map(order => (
                <div key={order.id} className="card">
                  <h3>{order.table}</h3>
                  <ul>
                    {order.items.map((item, index) => (
                      <li key={index}>{item.name} - ${item.price}</li>
                    ))}
                  </ul>
                  <button onClick={() => markAsReady(order.id)} className="btn-green">Mark as Ready</button>
                </div>
              ))
            )}
            <button onClick={() => setSection('home')} className="btn-gray">Back to Home</button>
          </div>
        );
      };

      // Admin Section
      const AdminSection = ({ setSection }) => {
        const [tableCount, setTableCount] = useState(5);
        const [menu, setMenu] = useState(defaultMenu);
        const [newCategory, setNewCategory] = useState('');
        const [newItem, setNewItem] = useState({ category: '', name: '', price: '' });
        const [editItem, setEditItem] = useState(null);
        const [orders, setOrders] = useState([]);

        useEffect(() => {
          if (!db) return;

          // Load settings
          db.ref('settings').once('value').then(snapshot => {
            const settings = snapshot.val() || {};
            setTableCount(settings.tableCount || 5);
            setMenu(settings.menu || defaultMenu);
          }).catch(error => console.error("Error loading settings:", error.message));

          // Load paid orders
          db.ref('orders').on('value', snapshot => {
            const orderData = snapshot.val();
            if (orderData) {
              const paidOrders = Object.entries(orderData)
                .filter(([_, order]) => order.status === 'paid')
                .map(([id, order]) => ({ id, ...order }));
              setOrders(paidOrders);
            } else {
              setOrders([]);
            }
          }, error => console.error("Error loading paid orders:", error.message));
        }, []);

        const updateTableCount = () => {
          if (!db) return;
          db.ref('settings').update({ tableCount: parseInt(tableCount) }).catch(error => console.error("Error updating table count:", error.message));
        };

        const addCategory = () => {
          if (!newCategory || !db) return;
          const updatedMenu = { ...menu, [newCategory]: [] };
          setMenu(updatedMenu);
          db.ref('settings').update({ menu: updatedMenu }).then(() => {
            setNewCategory('');
          }).catch(error => console.error("Error adding category:", error.message));
        };

        const addMenuItem = () => {
          if (!newItem.category || !newItem.name || !newItem.price || !db) return;
          const updatedMenu = { ...menu };
          const categoryItems = updatedMenu[newItem.category] || [];
          updatedMenu[newItem.category] = [
            ...categoryItems,
            { id: Date.now(), name: newItem.name, price: parseFloat(newItem.price) }
          ];
          setMenu(updatedMenu);
          db.ref('settings').update({ menu: updatedMenu }).then(() => {
            setNewItem({ category: '', name: '', price: '' });
          }).catch(error => console.error("Error adding menu item:", error.message));
        };

        const updateMenuItem = () => {
          if (!editItem || !db) return;
          const updatedMenu = { ...menu };
          updatedMenu[editItem.category] = updatedMenu[editItem.category].map(item =>
            item.id === editItem.id ? { ...item, name: editItem.name, price: parseFloat(editItem.price) } : item
          );
          setMenu(updatedMenu);
          db.ref('settings').update({ menu: updatedMenu }).then(() => {
            setEditItem(null);
          }).catch(error => console.error("Error updating menu item:", error.message));
        };

        const deleteMenuItem = (category, id) => {
          if (!db) return;
          const updatedMenu = { ...menu };
          updatedMenu[category] = updatedMenu[category].filter(item => item.id !== id);
          if (updatedMenu[category].length === 0) delete updatedMenu[category];
          setMenu(updatedMenu);
          db.ref('settings').update({ menu: updatedMenu }).catch(error => console.error("Error deleting menu item:", error.message));
        };

        return (
          <div className="section overflow-auto">
            <h2>Admin Section</h2>
            <div style={{ marginBottom: '15px' }}>
              <h3>Set Table Count</h3>
              <input
                type="number"
                value={tableCount}
                onChange={(e) => setTableCount(e.target.value)}
                style={{ width: '100px' }}
              />
              <button onClick={updateTableCount} className="btn-blue">Update</button>
            </div>
            <div style={{ marginBottom: '15px' }}>
              <h3>Add Category</h3>
              <input
                type="text"
                placeholder="Category Name"
                value={newCategory}
                onChange={(e) => setNewCategory(e.target.value)}
              />
              <button onClick={addCategory} className="btn-blue">Add Category</button>
            </div>
            <div style={{ marginBottom: '15px' }}>
              <h3>Add Menu Item</h3>
              <select
                value={newItem.category}
                onChange={(e) => setNewItem({ ...newItem, category: e.target.value })}
              >
                <option value="">Select Category</option>
                {Object.keys(menu).map(category => (
                  <option key={category} value={category}>{category}</option>
                ))}
              </select>
              <input
                type="text"
                placeholder="Item Name"
                value={newItem.name}
                onChange={(e) => setNewItem({ ...newItem, name: e.target.value })}
              />
              <input
                type="number"
                placeholder="Price"
                value={newItem.price}
                onChange={(e) => setNewItem({ ...newItem, price: e.target.value })}
                style={{ width: '100px' }}
              />
              <button onClick={addMenuItem} className="btn-blue">Add Item</button>
            </div>
            <div style={{ marginBottom: '15px' }}>
              <h3>Manage Menu</h3>
              {Object.keys(menu).map(category => (
                <div key={category} style={{ marginBottom: '10px' }}>
                  <h4>{category}</h4>
                  {menu[category].map(item => (
                    <div key={item.id} className="flex-row">
                      <span style={{ marginRight: '10px' }}>{item.name} - ${item.price}</span>
                      <button
                        onClick={() => setEditItem({ ...item, category })}
                        className="btn-yellow"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => deleteMenuItem(category, item.id)}
                        className="btn-red"
                      >
                        Delete
                      </button>
                    </div>
                  ))}
                </div>
              ))}
              {editItem && (
                <div style={{ marginTop: '15px' }}>
                  <h4>Edit Item</h4>
                  <input
                    type="text"
                    value={editItem.name}
                    onChange={(e) => setEditItem({ ...editItem, name: e.target.value })}
                  />
                  <input
                    type="number"
                    value={editItem.price}
                    onChange={(e) => setEditItem({ ...editItem, price: e.target.value })}
                    style={{ width: '100px' }}
                  />
                  <button onClick={updateMenuItem} className="btn-blue">Save</button>
                  <button onClick={() => setEditItem(null)} className="btn-gray">Cancel</button>
                </div>
              )}
            </div>
            <h3>Order History</h3>
            {orders.length === 0 ? (
              <p>No paid orders.</p>
            ) : (
              orders.map(order => (
                <div key={order.id} className="card">
                  <h4>{order.table} - {new Date(order.paidTimestamp).toLocaleString()}</h4>
                  <ul>
                    {order.items.map((item, index) => (
                      <li key={index}>{item.name} - ${item.price}</li>
                    ))}
                  </ul>
                </div>
              ))
            )}
            <button onClick={() => setSection('home')} className="btn-gray">Back to Home</button>
          </div>
        );
      };

      // Main App
      const App = () => {
        const [section, setSection] = useState('home');

        return (
          <ErrorBoundary>
            <div>
              {section === 'home' && <Home setSection={setSection} />}
              {section === 'order' && <OrderSection setSection={setSection} />}
              {section === 'kitchen' && <KitchenSection setSection={setSection} />}
              {section === 'admin' && <AdminSection setSection={setSection} />}
            </div>
          </ErrorBoundary>
        );
      };

      // Render the app only if Firebase is initialized
      if (app && db) {
        ReactDOM.render(<App />, document.getElementById('root'));
        console.log("App rendered successfully. Firebase initialized:", app.name);
      }
    } catch (error) {
      console.error("Runtime error:", error.message, error.stack);
      displayError(
        "Runtime Error",
        "An unexpected error occurred.",
        error.message
      );
    }
  </script>
</body>
</html>
